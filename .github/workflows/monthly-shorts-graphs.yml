# .github/workflows/monthly-shorts-graphs.yml
name: Monthly Shorts Graph Generation

on:
  schedule:
    - cron: '0 4 3 * *'   # 04:00‚ÄØUTC del d√≠a 3 de cada mes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-graphs:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: üõ† Create folders
        run: |
          mkdir -p data/shorts
          mkdir -p data/shorts/graficos

      - name: üêç Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üì¶ Install dependencies
        run: |
          # Dependencias de shorts_analysis.py
          pip install -r extractor/requirements.txt
          # Librer√≠as para an√°lisis longitudinal y gr√°ficos
          pip install pandas matplotlib

      - name: ‚ñ∂Ô∏è Run monthly Shorts extraction
        run: python extractor/shorts_analysis.py

      - name: ‚ñ∂Ô∏è Run longitudinal graphing
        run: python extractor/shorts_growth_analysis.py

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Verify outputs
        run: |
          ls -l data/shorts/resumen_shorts.csv   || echo "‚ö†Ô∏è resumen_shorts.csv missing"
          ls -l data/shorts/graficos/*.png       || echo "‚ö†Ô∏è No graphs generated"

      - name: üìÑ Commit and Push results (robust)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          FILES_ADDED=false

          if [ -f data/shorts/resumen_shorts.csv ]; then
            git add data/shorts/resumen_shorts.csv
            FILES_ADDED=true
          else
            echo "‚ÑπÔ∏è resumen_shorts.csv not found, skipping"
          fi

          if ls data/shorts/graficos/*.png 1> /dev/null 2>&1; then
            git add data/shorts/graficos/*.png
            FILES_ADDED=true
          else
            echo "‚ÑπÔ∏è No graphs to add, skipping"
          fi

          if [ "$FILES_ADDED" = "true" ]; then
            git diff --cached --quiet || \
              git commit -m "chore: update monthly shorts graphs (run ${{ github.run_id }})"
            git push origin HEAD:main
          else
            echo "‚úÖ Nothing to commit"
          fi


